{% extends "base.html" %}
{% block title %}SSL Certificate Management{% endblock %}

{% block content %}
<div class="page-header">
  <h1>SSL Certificate Management</h1>
  <p>Upload certificates and restart Nginx manually. Files will replace existing ones automatically.</p>
</div>

<div class="content-container">
  <div class="card-row">
    <!-- Certificate Upload Card -->
    <div class="card ssl-card">
      <h2>Upload Certificate (.cert)</h2>
      <div class="drop-box" onclick="document.getElementById('certFile').click()">
        <input type="file" id="certFile" style="display:none" accept=".cert" onchange="showSelectedFile('certFile','certStatus')">
        <p id="certStatus">Click or drag .cert file here</p>
      </div>
      <div class="card-actions">
        <button class="btn btn-upload" onclick="uploadSSL('cert')">Upload Certificate</button>
        <button class="btn btn-remove" onclick="resetFile('certFile','certStatus')">Remove File</button>
      </div>
    </div>

    <!-- Key Upload Card -->
    <div class="card ssl-card">
      <h2>Upload Private Key (.key)</h2>
      <div class="drop-box" onclick="document.getElementById('keyFile').click()">
        <input type="file" id="keyFile" style="display:none" accept=".key" onchange="showSelectedFile('keyFile','keyStatus')">
        <p id="keyStatus">Click or drag .key file here</p>
      </div>
      <div class="card-actions">
        <button class="btn btn-upload" onclick="uploadSSL('key')">Upload Key</button>
        <button class="btn btn-remove" onclick="resetFile('keyFile','keyStatus')">Remove File</button>
      </div>
    </div>
  </div>

  <!-- Nginx Restart Button -->
  <button class="btn btn-restart" onclick="restartNginx()">Restart Nginx</button>
  <div class="status" id="nginxStatus"></div>
</div>
{% endblock %}

{% block extra_css %}
<style>
body { background: #f3f0ff; font-family: 'Segoe UI', sans-serif; }
.page-header { text-align: center; margin: 30px 0; }
.page-header h1 { font-size: 2.5em; color: #6b21a8; }
.page-header p { font-size: 1.1em; color: #4b5563; margin-top: 5px; }

.content-container { width: 90%; max-width: 1000px; margin: auto; display: flex; flex-direction: column; gap: 25px; align-items: center; }
.card-row { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }

.card { background: #ffffff; border-radius: 16px; padding: 30px 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); width: 450px; text-align: center; }
.card h2 { margin-bottom: 20px; color: #7e22ce; }

.drop-box { border: 2px dashed #a855f7; padding: 40px; border-radius: 12px; cursor: pointer; background: #f8f7ff; transition: 0.3s; }
.drop-box:hover { background: #e9e6ff; }
.drop-box p { margin: 0; color: #6b21a8; font-size: 1em; }

.card-actions { display: flex; justify-content: center; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
.btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; transition: 0.3s; font-weight: 600; }
.btn-upload { background: linear-gradient(90deg,#7e22ce,#a855f7); color: #fff; }
.btn-upload:hover { background: linear-gradient(90deg,#6b21a8,#9333ea); }
.btn-remove { background: #f87171; color: #fff; }
.btn-remove:hover { background: #dc2626; }
.btn-restart { background: #fbbf24; color: #111827; padding: 14px 40px; font-weight: 700; border-radius: 12px; }
.btn-restart:hover { background: #f59e0b; }

.status { margin-top: 10px; font-size: 0.95em; min-height: 18px; text-align: center; }
.status.success { color: #16a34a; }
.status.error { color: #dc2626; }
</style>
{% endblock %}

{% block extra_js %}
<script>
function showSelectedFile(fileId, statusId) {
    const fileInput = document.getElementById(fileId);
    const status = document.getElementById(statusId);

    if (fileInput.files.length) {
        const fileName = fileInput.files[0].name;
        status.textContent = `Already selected: ${fileName}`;
        status.className = "status";
    } else {
        status.textContent = "Click or drag file here";
        status.className = "status";
    }
}

function resetFile(fileId, statusId) {
    document.getElementById(fileId).value = "";
    document.getElementById(statusId).textContent = "Click or drag file here";
    document.getElementById(statusId).className = "status";
}

async function uploadSSL(type) {
    const fileInput = document.getElementById(type === 'cert' ? 'certFile' : 'keyFile');
    const status = document.getElementById(type === 'cert' ? 'certStatus' : 'keyStatus');

    if (!fileInput.files.length) {
        status.textContent = "No file selected!";
        status.className = "status error";
        return;
    }

    const file = fileInput.files[0];
    const allowedExt = type === 'cert' ? '.cert' : '.key';
    if (!file.name.toLowerCase().endsWith(allowedExt)) {
        status.textContent = `Invalid file type! Only ${allowedExt} allowed.`;
        status.className = "status error";
        return;
    }

    const formData = new FormData();
    formData.append("field", type);
    formData.append("file", file);

    status.textContent = "Uploading...";
    status.className = "status";
    try {
        const res = await fetch("/api/ssl_upload", { method: "POST", body: formData });
        const data = await res.json();
        status.textContent = data.message;
        status.className = data.status === "success" ? "status success" : "status error";
    } catch (err) {
        status.textContent = "Upload failed: " + err.message;
        status.className = "status error";
    }
}

async function restartNginx() {
    const status = document.getElementById("nginxStatus");
    status.textContent = "Restarting Nginx...";
    status.className = "status";
    try {
        const res = await fetch("/api/nginx_restart", { method: "POST" });
        const data = await res.json();
        status.textContent = data.message;
        status.className = data.status === "success" ? "status success" : "status error";
    } catch (err) {
        status.textContent = "Restart failed: " + err.message;
        status.className = "status error";
    }
}
</script>
{% endblock %}
