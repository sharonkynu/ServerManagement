{% extends "base.html" %}

{% block title %}Ports & Protocols - Server Management{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Ports & Protocols Configuration</h1>
    <p>Configure H323 and SIP protocols with automatic container management</p>
</div>

<div class="ports-grid">
    <!-- Protocol Configuration -->
    <div class="config-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-plug"></i>
            </div>
            <h3>Protocol Configuration</h3>
        </div>
        <div class="card-content">
            <form id="protocols-form">
                <!-- H323 Protocol -->
                <div class="protocol-section">
                    <div class="protocol-header">
                        <div class="protocol-info">
                            <div class="protocol-icon">
                                <i class="fas fa-video"></i>
                            </div>
                            <div class="protocol-details">
                                <h4>H.323 Protocol</h4>
                                <p>Video conferencing and VoIP protocol</p>
                            </div>
                        </div>
                        <div class="protocol-toggle">
                            <label class="switch">
                                <input type="checkbox" id="h323-enabled" name="h323_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="protocol-config" id="h323-config" style="display: none;">
                        <div class="config-grid">
                            <div class="form-group">
                                <label for="h323-port">Port</label>
                                <input type="number" id="h323-port" name="h323_port" value="1720" min="1" max="65535">
                            </div>
                            <div class="form-group">
                                <label for="h323-ports-range">Port Range</label>
                                <input type="text" id="h323-ports-range" name="h323_ports_range" value="1024-65535" placeholder="1024-65535">
                            </div>
                            <div class="form-group">
                                <label for="h323-gatekeeper">Gatekeeper</label>
                                <input type="text" id="h323-gatekeeper" name="h323_gatekeeper" placeholder="192.168.1.1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SIP Protocol -->
                <div class="protocol-section">
                    <div class="protocol-header">
                        <div class="protocol-info">
                            <div class="protocol-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div class="protocol-details">
                                <h4>SIP Protocol</h4>
                                <p>Session Initiation Protocol for VoIP</p>
                            </div>
                        </div>
                        <div class="protocol-toggle">
                            <label class="switch">
                                <input type="checkbox" id="sip-enabled" name="sip_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="protocol-config" id="sip-config" style="display: none;">
                        <div class="config-grid">
                            <div class="form-group">
                                <label for="sip-port">Port</label>
                                <input type="number" id="sip-port" name="sip_port" value="5060" min="1" max="65535">
                            </div>
                            <div class="form-group">
                                <label for="sip-tls-port">TLS Port</label>
                                <input type="number" id="sip-tls-port" name="sip_tls_port" value="5061" min="1" max="65535">
                            </div>
                            <div class="form-group">
                                <label for="sip-domain">Domain</label>
                                <input type="text" id="sip-domain" name="sip_domain" placeholder="example.com">
                            </div>
                            <div class="form-group">
                                <label for="sip-registrar">Registrar</label>
                                <input type="text" id="sip-registrar" name="sip_registrar" placeholder="sip.example.com">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Apply Configuration
                    </button>
                    <button type="button" class="btn btn-secondary" id="reset-protocols">
                        <i class="fas fa-undo"></i>
                        Reset
                    </button>
                    <button type="button" class="btn btn-info" id="test-protocols">
                        <i class="fas fa-flask"></i>
                        Test Protocols
                    </button>
                </div>
            </form>
      </div>
    </div>




<!--
    <!-- Environment Variables
    <div class="env-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-code"></i>
            </div>
            <h3>Environment Variables</h3>
        </div>
        <div class="card-content">
            <div class="env-variables" id="env-variables">
                <div class="env-item">
                    <div class="env-key">H323_ENABLED</div>
                    <div class="env-value">false</div>
                </div>
                <div class="env-item">
                    <div class="env-key">SIP_ENABLED</div>
                    <div class="env-value">false</div>
                </div>
                <div class="env-item">
                    <div class="env-key">H323_PORT</div>
                    <div class="env-value">1720</div>
                </div>
                <div class="env-item">
                    <div class="env-key">SIP_PORT</div>
                    <div class="env-value">5060</div>
                </div>
            </div>
            <div class="env-actions">
                <button class="btn btn-secondary" id="view-docker-compose">
                    <i class="fas fa-eye"></i>
                    View docker-compose.yml
                </button>
                <button class="btn btn-secondary" id="download-docker-compose">
                    <i class="fas fa-download"></i>
                    Download
                </button>
            </div>
        </div>
    </div> -->
-->

    <!-- Protocol Testing -->
    <div class="test-card">
        <div class="card-header">
            <div class="card-icon">
                <i class="fas fa-vial"></i>
            </div>
            <h3>Protocol Testing</h3>
        </div>
        <div class="card-content">
            <div class="test-tools">
                <div class="test-group">
                    <h4>H.323 Tests</h4>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testH323Connection()">
                            <i class="fas fa-video"></i>
                            Test H.323 Connection
                        </button>
                        <button class="test-btn" onclick="testH323Port()">
                            <i class="fas fa-plug"></i>
                            Test Port 1720
                        </button>
                    </div>
                </div>
                <div class="test-group">
                    <h4>SIP Tests</h4>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testSIPConnection()">
                            <i class="fas fa-phone"></i>
                            Test SIP Connection
                        </button>
                        <button class="test-btn" onclick="testSIPPort()">
                            <i class="fas fa-plug"></i>
                            Test Port 5060
                        </button>
                    </div>
                </div>
            </div>
            <div class="test-output" id="test-output">
                <div class="output-header">
                    <span>Test Results</span>
                    <button class="clear-output" onclick="clearTestOutput()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="output-content" id="test-content">
                    Select a test to see results here.
                </div>
        </div>
      </div>
    </div>
  </div>

<!-- Modal for docker-compose.yml -->
<div class="modal" id="docker-compose-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>docker-compose.yml</h3>
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <pre id="docker-compose-content">Loading...</pre>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('protocols-form');
    const h323Toggle = document.getElementById('h323-enabled');
    const sipToggle = document.getElementById('sip-enabled');
    const h323Config = document.getElementById('h323-config');
    const sipConfig = document.getElementById('sip-config');

    // Load current configuration
    loadCurrentConfig();

    // Toggle protocol configurations
    h323Toggle.addEventListener('change', function() {
        if (this.checked) {
            h323Config.style.display = 'block';
            h323Config.style.animation = 'slideDown 0.3s ease-out';
        } else {
            h323Config.style.display = 'none';
        }
    });

    sipToggle.addEventListener('change', function() {
        if (this.checked) {
            sipConfig.style.display = 'block';
            sipConfig.style.animation = 'slideDown 0.3s ease-out';
        } else {
            sipConfig.style.display = 'none';
        }
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const config = {
            h323_enabled: h323Toggle.checked,
            sip_enabled: sipToggle.checked,
            h323_port: formData.get('h323_port'),
            h323_ports_range: formData.get('h323_ports_range'),
            h323_gatekeeper: formData.get('h323_gatekeeper'),
            sip_port: formData.get('sip_port'),
            sip_tls_port: formData.get('sip_tls_port'),
            sip_domain: formData.get('sip_domain'),
            sip_registrar: formData.get('sip_registrar')
        };

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';
        submitBtn.disabled = true;

        fetch('/api/ports_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('Protocol configuration updated and container restarted!', 'success');
                loadCurrentConfig(); // Reload configuration
                updatePortStatus();
                updateContainerStatus();
            } else {
                showNotification(data.message || 'Failed to update configuration', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error occurred', 'error');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });

    // Reset form
    document.getElementById('reset-protocols').addEventListener('click', function() {
        form.reset();
        h323Config.style.display = 'none';
        sipConfig.style.display = 'none';
    });

    // Test protocols
    document.getElementById('test-protocols').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        btn.disabled = true;

        // Mock protocol test
        setTimeout(() => {
            showNotification('Protocol tests completed successfully!', 'success');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 3000);
    });

    // View docker-compose.yml
    document.getElementById('view-docker-compose').addEventListener('click', function() {
        showDockerComposeModal();
    });

    // Download docker-compose.yml
    document.getElementById('download-docker-compose').addEventListener('click', function() {
        downloadDockerCompose();
    });

    // Refresh containers
    document.getElementById('refresh-containers').addEventListener('click', function() {
        updateContainerStatus();
    });

    function loadCurrentConfig() {
        // Mock current configuration - in real implementation, fetch from backend
        updateEnvVariables();
        updatePortStatus();
    }

    function updateEnvVariables() {
        const envVars = document.getElementById('env-variables');
        const h323Enabled = h323Toggle.checked;
        const sipEnabled = sipToggle.checked;

        envVars.innerHTML = `
            <div class="env-item">
                <div class="env-key">H323_ENABLED</div>
                <div class="env-value">${h323Enabled.toString()}</div>
            </div>
            <div class="env-item">
                <div class="env-key">SIP_ENABLED</div>
                <div class="env-value">${sipEnabled.toString()}</div>
            </div>
            <div class="env-item">
                <div class="env-key">H323_PORT</div>
                <div class="env-value">${document.getElementById('h323-port').value}</div>
            </div>
            <div class="env-item">
                <div class="env-key">SIP_PORT</div>
                <div class="env-value">${document.getElementById('sip-port').value}</div>
            </div>
        `;
    }

    function updatePortStatus() {
        const portList = document.getElementById('port-list');
        const ports = [
            { port: 1720, protocol: 'H.323', status: h323Toggle.checked ? 'open' : 'closed' },
            { port: 5060, protocol: 'SIP', status: sipToggle.checked ? 'open' : 'closed' },
            { port: 5061, protocol: 'SIP TLS', status: sipToggle.checked ? 'open' : 'closed' },
            { port: 80, protocol: 'HTTP', status: 'open' },
            { port: 443, protocol: 'HTTPS', status: 'open' }
        ];

        portList.innerHTML = '';
        ports.forEach(port => {
            const portItem = document.createElement('div');
            portItem.className = `port-item ${port.status}`;
            portItem.innerHTML = `
                <div class="port-info">
                    <div class="port-number">${port.port}</div>
                    <div class="port-protocol">${port.protocol}</div>
                </div>
                <div class="port-status">
                    <span class="status-dot ${port.status}"></span>
                    ${port.status.toUpperCase()}
                </div>
            `;
            portList.appendChild(portItem);
        });
    }

    function updateContainerStatus() {
        // Mock container status update - in real implementation, fetch from Docker API
        const containerStatus = document.getElementById('container-status');
        containerStatus.innerHTML = `
            <div class="container-item">
                <div class="container-info">
                    <div class="container-name">app</div>
                    <div class="container-status-text">
                        <span class="status-dot running"></span>
                        Running
                    </div>
                </div>
                <div class="container-actions">
                    <button class="action-btn" onclick="restartContainer('app')">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="action-btn" onclick="stopContainer('app')">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>
        `;
    }

    function showDockerComposeModal() {
        const modal = document.getElementById('docker-compose-modal');
        const content = document.getElementById('docker-compose-content');
        
        // Mock docker-compose content - in real implementation, read from file
        const dockerComposeContent = `version: '3.8'
services:
  app:
    build: .
    ports:
      - "5000:5000"
    environment:
      - H323_ENABLED=${h323Toggle.checked.toString()}
      - SIP_ENABLED=${sipToggle.checked.toString()}
      - H323_PORT=${document.getElementById('h323-port').value}
      - SIP_PORT=${document.getElementById('sip-port').value}
      - SSL_ENABLED=false`;

        content.textContent = dockerComposeContent;
        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById('docker-compose-modal').style.display = 'none';
    }

    function downloadDockerCompose() {
        // Mock download - in real implementation, generate and download file
        showNotification('docker-compose.yml downloaded!', 'success');
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
            ${message}
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Initialize
    updatePortStatus();
    updateContainerStatus();

    // Animate cards on load
    const cards = document.querySelectorAll('.config-card, .status-card, .container-card, .env-card, .test-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-in');
    });
});

// Global functions
function restartContainer(containerName) {
    showNotification(`Restarting container ${containerName}...`, 'info');
    // Mock restart - in real implementation, call Docker API
    setTimeout(() => {
        showNotification(`Container ${containerName} restarted successfully!`, 'success');
    }, 2000);
}

function stopContainer(containerName) {
    showNotification(`Stopping container ${containerName}...`, 'info');
    // Mock stop - in real implementation, call Docker API
    setTimeout(() => {
        showNotification(`Container ${containerName} stopped successfully!`, 'success');
    }, 1500);
}

function toggleLogs() {
    const logsContent = document.getElementById('logs-content');
    const toggleBtn = document.querySelector('.logs-toggle i');
    
    if (logsContent.style.display === 'none') {
        logsContent.style.display = 'block';
        logsContent.style.animation = 'slideDown 0.3s ease-out';
        toggleBtn.style.transform = 'rotate(180deg)';
        
        // Mock logs loading
        document.getElementById('logs-text').textContent = `Container logs for app:
[2024-01-15 10:30:15] INFO: Starting application
[2024-01-15 10:30:16] INFO: H323 protocol disabled
[2024-01-15 10:30:16] INFO: SIP protocol disabled
[2024-01-15 10:30:16] INFO: Server listening on port 5000`;
    } else {
        logsContent.style.display = 'none';
        toggleBtn.style.transform = 'rotate(0deg)';
    }
}

function testH323Connection() {
    const output = document.getElementById('test-content');
    output.innerHTML = '<div class="loading-output"><i class="fas fa-spinner fa-spin"></i> Testing H.323 connection...</div>';
    
    setTimeout(() => {
        output.innerHTML = `<pre>H.323 Connection Test Results:
✓ Port 1720 is accessible
✓ H.323 protocol stack loaded
✓ Gatekeeper registration successful
✓ Video codec negotiation ready

Connection Status: SUCCESS
Response Time: 45ms</pre>`;
    }, 2000);
}

function testH323Port() {
    const output = document.getElementById('test-content');
    output.innerHTML = '<div class="loading-output"><i class="fas fa-spinner fa-spin"></i> Testing port 1720...</div>';
    
    setTimeout(() => {
        output.innerHTML = `<pre>Port 1720 Test Results:
✓ Port is open and listening
✓ TCP connection established
✓ H.323 handshake successful

Port Status: OPEN
Response Time: 12ms</pre>`;
    }, 1500);
}

function testSIPConnection() {
    const output = document.getElementById('test-content');
    output.innerHTML = '<div class="loading-output"><i class="fas fa-spinner fa-spin"></i> Testing SIP connection...</div>';
    
    setTimeout(() => {
        output.innerHTML = `<pre>SIP Connection Test Results:
✓ Port 5060 is accessible
✓ SIP protocol stack loaded
✓ Registrar registration successful
✓ RTP media negotiation ready

Connection Status: SUCCESS
Response Time: 38ms</pre>`;
    }, 2000);
}

function testSIPPort() {
    const output = document.getElementById('test-content');
    output.innerHTML = '<div class="loading-output"><i class="fas fa-spinner fa-spin"></i> Testing port 5060...</div>';
    
    setTimeout(() => {
        output.innerHTML = `<pre>Port 5060 Test Results:
✓ Port is open and listening
✓ UDP connection established
✓ SIP INVITE handshake successful

Port Status: OPEN
Response Time: 8ms</pre>`;
    }, 1500);
}

function clearTestOutput() {
    document.getElementById('test-content').innerHTML = 'Select a test to see results here.';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('docker-compose-modal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}