{% extends "base.html" %}
{% block title %}Ports & Protocols - Server Management{% endblock %}

{% block content %}
<style>
/* --- Layout --- */
.page-header { text-align:center; margin-bottom:25px; }
.ports-grid { display:flex; flex-direction:column; align-items:center; gap:25px; }
.config-card, .test-card { background:#fff; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.08); width:90%; max-width:800px; padding:25px; animation:fadeInUp 0.5s ease-out; }
.card-header { display:flex; align-items:center; gap:10px; margin-bottom:20px; }
.card-header h3 { font-size:1.4rem; margin:0; }
.card-icon i { background:#007BFF; color:white; padding:10px; border-radius:10px; }

/* --- Protocols --- */
.protocol-section { border:1px solid #eee; border-radius:12px; padding:15px; margin-bottom:15px; background:#fafafa; transition:all 0.3s ease; }
.protocol-header { display:flex; justify-content:space-between; align-items:center; }
.protocol-info { display:flex; align-items:center; gap:10px; }
.protocol-details h4 { margin:0; font-weight:600; }
.protocol-details p { margin:0; font-size:0.9em; color:#666; }

/* --- Toggle Switch --- */
.switch { position:relative; display:inline-block; width:55px; height:28px; }
.switch input { display:none; }
.slider { position:absolute; cursor:pointer; background-color:#ccc; border-radius:34px; top:0; left:0; right:0; bottom:0; transition:.4s; }
.slider:before { position:absolute; content:""; height:20px; width:20px; left:4px; bottom:4px; background:white; transition:.4s; border-radius:50%; }
input:checked + .slider { background-color:#007BFF; }
input:checked + .slider:before { transform:translateX(26px); }

/* --- Form --- */
.config-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px; }
.form-group label { display:block; font-weight:500; margin-bottom:5px; }
input[type="number"], input[type="text"] { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #ccc; transition:border 0.3s ease; }
input:focus { border-color:#007BFF; outline:none; }

/* --- Buttons --- */
.form-actions { text-align:center; margin-top:25px; display:flex; justify-content:center; gap:15px; }
.btn { padding:10px 18px; border:none; border-radius:8px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:6px; transition:background 0.3s ease; }
.btn-primary { background:#007BFF; color:white; } .btn-primary:hover { background:#0056b3; }
.btn-secondary { background:#6c757d; color:white; } .btn-secondary:hover { background:#565e64; }
.btn-info { background:#17a2b8; color:white; } .btn-info:hover { background:#117a8b; }

/* --- Test Section --- */
.test-card h4 { font-size:1.1rem; margin-bottom:8px; }
.test-buttons { display:flex; flex-wrap:wrap; gap:10px; }
.test-btn { background:#007BFF; color:white; border:none; border-radius:6px; padding:8px 14px; cursor:pointer; transition:all 0.3s ease; }
.test-btn:hover { background:#0056b3; }
.test-output { background:#111; color:#0f0; font-family:monospace; border-radius:8px; margin-top:15px; padding:12px; height:200px; overflow-y:auto; }

/* --- Notifications --- */
.notification { position:fixed; top:20px; right:-400px; background:#333; color:white; padding:12px 20px; border-radius:8px; opacity:0; z-index:1000; display:flex; align-items:center; gap:8px; transition: all 0.5s ease; }
.notification.show { right:20px; opacity:1; }
.notification-success { background:#28a745; }
.notification-error { background:#dc3545; }

/* --- Port Management Styles --- */
.ports-table-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
.ports-table-header h5 { margin:0; font-size:1.1rem; font-weight:600; }
.ports-table { background:#f8f9fa; border-radius:8px; padding:15px; min-height:100px; }
.loading-ports { text-align:center; color:#666; padding:20px; }
.port-row { display:flex; align-items:center; justify-content:space-between; background:white; border:1px solid #e9ecef; border-radius:6px; padding:12px; margin-bottom:8px; transition:all 0.3s ease; }
.port-row:hover { box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.port-info { display:flex; align-items:center; gap:12px; flex:1; }
.port-name { font-weight:600; color:#333; }
.port-number { background:#007BFF; color:white; padding:4px 8px; border-radius:4px; font-size:0.9em; font-weight:600; }
.port-status { display:flex; align-items:center; gap:8px; }
.port-actions { display:flex; align-items:center; gap:8px; }
.delete-port-btn { background:#dc3545; color:white; border:none; border-radius:4px; padding:6px 10px; cursor:pointer; font-size:0.8em; transition:background 0.3s ease; }
.delete-port-btn:hover { background:#c82333; }
.empty-ports { text-align:center; color:#666; padding:30px; font-style:italic; }

/* --- Animations --- */
@keyframes fadeInUp { from { transform:translateY(15px); opacity:0; } to { transform:translateY(0); opacity:1; } }
@keyframes slideDown { from { max-height:0; opacity:0; } to { max-height:500px; opacity:1; } }
</style>

<div class="page-header">
    <h1>Ports & Protocols Configuration</h1>
    <p>Toggle SIP and H.323 settings and apply changes instantly.</p>
</div>

<div class="ports-grid">
    <div class="config-card">
        <div class="card-header">
            <div class="card-icon"><i class="fas fa-plug"></i></div>
            <h3>Protocol Configuration</h3>
        </div>
        <form id="protocols-form">
            <!-- H323 Section -->
            <div class="protocol-section">
                <div class="protocol-header">
                    <div class="protocol-info">
                        <i class="fas fa-video"></i>
                        <div class="protocol-details">
                            <h4>H.323 Protocol</h4>
                            <p>Video conferencing and VoIP protocol</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="h323-enabled" name="h323_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="protocol-config" id="h323-config" style="display:none;">
                    <div class="config-grid">
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" id="h323-port" name="h323_port" value="1720">
                        </div>
                        <div class="form-group">
                            <label>Port Range</label>
                            <input type="text" id="h323-ports-range" name="h323_ports_range" value="1024-65535">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SIP Section -->
            <div class="protocol-section">
                <div class="protocol-header">
                    <div class="protocol-info">
                        <i class="fas fa-phone"></i>
                        <div class="protocol-details">
                            <h4>SIP Protocol</h4>
                            <p>Session Initiation Protocol for VoIP</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="sip-enabled" name="sip_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="protocol-config" id="sip-config" style="display:none;">
                    <div class="config-grid">
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" id="sip-port" name="sip_port" value="5060">
                        </div>
                        <div class="form-group">
                            <label>TLS Port</label>
                            <input type="number" id="sip-tls-port" name="sip_tls_port" value="5061">
                        </div>
                        <div class="form-group">
                            <label>Domain</label>
                            <input type="text" id="sip-domain" name="sip_domain" placeholder="example.com">
                        </div>
                        <div class="form-group">
                            <label>Registrar</label>
                            <input type="text" id="sip-registrar" name="sip_registrar" placeholder="sip.example.com">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Apply</button>
                <button type="button" class="btn btn-secondary" id="reset-protocols"><i class="fas fa-undo"></i> Reset</button>
            </div>

            <div id="apply-status" style="margin-top:12px; font-weight:500;"></div>
        </form>
    </div>

    <!-- Port Management Section -->
    <div class="config-card">
        <div class="card-header">
            <div class="card-icon"><i class="fas fa-network-wired"></i></div>
            <h3>Port Management</h3>
        </div>
        
        <!-- Show System Open Ports -->
        <div class="protocol-section">
            <div class="protocol-header">
                <div class="protocol-info">
                    <i class="fas fa-list"></i>
                    <div class="protocol-details">
                        <h4>System Open Ports</h4>
                        <p>View currently open ports on the system</p>
                    </div>
                </div>
                <button type="button" class="btn btn-info" id="show-open-ports">
                    <i class="fas fa-eye"></i> Show Open Ports
                </button>
            </div>
            <div id="open-ports-list" style="display:none; margin-top:15px;">
                <div class="test-output" id="open-ports-content">
                    Click "Show Open Ports" to load the list...
                </div>
            </div>
        </div>

        <!-- Port Management Table -->
        <div class="protocol-section">
            <div class="protocol-header">
                <div class="protocol-info">
                    <i class="fas fa-cogs"></i>
                    <div class="protocol-details">
                        <h4>Port Configuration</h4>
                        <p>Manage port access and permissions</p>
                    </div>
                </div>
            </div>
            
            <div id="ports-table-container" style="margin-top:15px;">
                <div class="ports-table-header">
                    <h5>Configured Ports</h5>
                    <button type="button" class="btn btn-primary" id="refresh-ports">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="ports-table" id="ports-table">
                    <div class="loading-ports">
                        <i class="fas fa-spinner fa-spin"></i> Loading ports...
                    </div>
                </div>
            </div>
        </div>

        <!-- Add New Port Section -->
        <div class="protocol-section">
            <div class="protocol-header">
                <div class="protocol-info">
                    <i class="fas fa-plus"></i>
                    <div class="protocol-details">
                        <h4>Add New Port</h4>
                        <p>Add a new port to the system</p>
                    </div>
                </div>
            </div>
            
            <form id="add-port-form" style="margin-top:15px;">
                <div class="config-grid">
                    <div class="form-group">
                        <label>Port Name</label>
                        <input type="text" id="new-port-name" name="port_name" placeholder="e.g., Web Server" required>
                    </div>
                    <div class="form-group">
                        <label>Port Number</label>
                        <input type="number" id="new-port-number" name="port_number" placeholder="e.g., 8080" min="1" max="65535" required>
                    </div>
                    <div class="form-group">
                        <label>Enable Port</label>
                        <label class="switch">
                            <input type="checkbox" id="new-port-enabled" name="port_enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Port
                    </button>
                </div>
            </form>
        </div>

        <!-- Apply Changes -->
        <div class="form-actions" style="margin-top:25px;">
            <button type="button" class="btn btn-primary" id="apply-port-changes">
                <i class="fas fa-save"></i> Apply Changes
            </button>
            <button type="button" class="btn btn-secondary" id="reset-port-changes">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>

        <div id="port-apply-status" style="margin-top:12px; font-weight:500;"></div>
    </div>
<!--
    <div class="test-card">
        <div class="card-header">
            <div class="card-icon"><i class="fas fa-vial"></i></div>
            <h3>Protocol Testing</h3>
        </div>
        <div class="test-tools">
            <div class="test-group">
                <h4>H.323 Tests</h4>
                <div class="test-buttons">
                    <button class="test-btn" onclick="testH323Connection()">Test H.323</button>
                    <button class="test-btn" onclick="testH323Port()">Test Port 1720</button>
                </div>
            </div>
            <div class="test-group">
                <h4>SIP Tests</h4>
                <div class="test-buttons">
                    <button class="test-btn" onclick="testSIPConnection()">Test SIP</button>
                    <button class="test-btn" onclick="testSIPPort()">Test Port 5060</button>
                </div>
            </div>
        </div>
        <div class="test-output" id="test-content">
            Select a test to see results here.
        </div>
    </div>
</div>
-->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("protocols-form");
  const h323Toggle = document.getElementById("h323-enabled");
  const sipToggle = document.getElementById("sip-enabled");
  const h323Config = document.getElementById("h323-config");
  const sipConfig = document.getElementById("sip-config");
  const applyStatus = document.getElementById("apply-status");

  function showNotification(msg, type) {
    const n = document.createElement('div');
    n.className = `notification notification-${type}`;
    n.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-triangle'}"></i> ${msg}`;
    document.body.appendChild(n);
    setTimeout(()=>n.classList.add('show'),100);
    setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>document.body.removeChild(n),300); },3000);
  }

  function updateConfigUI(state){
    h323Toggle.checked = state.h323_enabled;
    sipToggle.checked = state.sip_enabled;
    document.getElementById('h323-port').value = state.h323_port;
    document.getElementById('sip-port').value = state.sip_port;
    h323Config.style.display = state.h323_enabled ? 'block' : 'none';
    sipConfig.style.display = state.sip_enabled ? 'block' : 'none';
  }

  // Load current state
  fetch('/api/ports_config_state')
    .then(res=>res.json())
    .then(data=>{ if(data.status==='success') updateConfigUI(data.current_state); });

  // Mutual exclusion toggle
  h323Toggle.addEventListener('change',()=>{ if(h323Toggle.checked){ sipToggle.checked=false; sipConfig.style.display='none'; h323Config.style.display='block'; } else h323Config.style.display='none'; });
  sipToggle.addEventListener('change',()=>{ if(sipToggle.checked){ h323Toggle.checked=false; h323Config.style.display='none'; sipConfig.style.display='block'; } else sipConfig.style.display='none'; });

  // Submit form
  form.addEventListener('submit', e=>{
    e.preventDefault();
    const config={
      h323_enabled:h323Toggle.checked,
      sip_enabled:sipToggle.checked,
      h323_port:document.getElementById('h323-port').value,
      sip_port:document.getElementById('sip-port').value
    };
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Applying...';
    btn.disabled=true;

    fetch('/api/ports_config',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body:JSON.stringify(config) })
      .then(res=>res.json())
      .then(data=>{
        if(data.status==='success'){
          updateConfigUI(data.current_state);
          showNotification(data.message,'success');
          if(applyStatus) applyStatus.textContent=`Configuration applied. Containers restarted at ${new Date().toLocaleTimeString()}`;
        } else showNotification(data.message||'Failed to apply configuration','error');
      }).catch(err=>showNotification('Network error','error'))
      .finally(()=>{ btn.innerHTML=originalText; btn.disabled=false; });

  });

  // Reset form
  document.getElementById('reset-protocols').addEventListener('click',()=>{
    form.reset();
    h323Config.style.display='none';
    sipConfig.style.display='none';
    if(applyStatus) applyStatus.textContent='';
  });

  // Port Management functionality
  const portsTable = document.getElementById('ports-table');
  const openPortsList = document.getElementById('open-ports-list');
  const openPortsContent = document.getElementById('open-ports-content');
  const showOpenPortsBtn = document.getElementById('show-open-ports');
  const refreshPortsBtn = document.getElementById('refresh-ports');
  const addPortForm = document.getElementById('add-port-form');
  const applyPortChangesBtn = document.getElementById('apply-port-changes');
  const resetPortChangesBtn = document.getElementById('reset-port-changes');
  const portApplyStatus = document.getElementById('port-apply-status');

  let portsData = [];
  let hasUnsavedChanges = false;

  // Load ports data
  function loadPorts() {
    portsTable.innerHTML = '<div class="loading-ports"><i class="fas fa-spinner fa-spin"></i> Loading ports...</div>';
    
    // Default ports that should always be available
    const defaultPorts = [
      { id: 'http', name: 'HTTP', port: 80, enabled: true, isDefault: true },
      { id: 'https', name: 'HTTPS', port: 443, enabled: true, isDefault: true },
      { id: 'ssh', name: 'SSH', port: 22, enabled: true, isDefault: true }
    ];
    
    fetch('/api/check_port_status')
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          // Merge default ports with configured ports
          const configuredPorts = data.ports || [];
          const mergedPorts = [...defaultPorts];
          
          // Add configured ports that aren't defaults
          configuredPorts.forEach(port => {
            const isDefault = defaultPorts.some(dp => dp.port === port.port);
            if (!isDefault) {
              mergedPorts.push({ ...port, isDefault: false });
            } else {
              // Update default port with configured status
              const defaultIndex = mergedPorts.findIndex(dp => dp.port === port.port);
              if (defaultIndex !== -1) {
                mergedPorts[defaultIndex] = { ...mergedPorts[defaultIndex], enabled: port.enabled };
              }
            }
          });
          
          portsData = mergedPorts;
          renderPortsTable();
        } else {
          // If API fails, show default ports
          portsData = defaultPorts;
          renderPortsTable();
        }
      })
      .catch(err => {
        // If API fails, show default ports
        portsData = defaultPorts;
        renderPortsTable();
      });
  }

  // Render ports table
  function renderPortsTable() {
    if (portsData.length === 0) {
      portsTable.innerHTML = '<div class="empty-ports">No ports configured. Add a new port below.</div>';
      return;
    }

    const html = portsData.map(port => `
      <div class="port-row" data-port-id="${port.id || port.port}">
        <div class="port-info">
          <div class="port-name">
            ${port.name || 'Unnamed Port'}
            ${port.isDefault ? ' <span style="color: #007BFF; font-size: 0.8em;">(Default)</span>' : ''}
          </div>
          <div class="port-number">${port.port}</div>
        </div>
        <div class="port-status">
          <label class="switch">
            <input type="checkbox" class="port-toggle" ${port.enabled ? 'checked' : ''} data-port-id="${port.id || port.port}">
            <span class="slider"></span>
          </label>
        </div>
        <div class="port-actions">
          ${port.isDefault ? 
            '<span style="color: #666; font-size: 0.8em;">System</span>' : 
            `<button type="button" class="delete-port-btn" onclick="deletePort('${port.id || port.port}')">
              <i class="fas fa-trash"></i>
            </button>`
          }
        </div>
      </div>
    `).join('');

    portsTable.innerHTML = html;

    // Add event listeners to toggles
    portsTable.querySelectorAll('.port-toggle').forEach(toggle => {
      toggle.addEventListener('change', () => {
        hasUnsavedChanges = true;
        updateApplyButton();
      });
    });
  }

  // Show system open ports
  function showSystemOpenPorts() {
    openPortsContent.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading system ports...';
    openPortsList.style.display = 'block';
    
    // Use a different approach to get system open ports
    fetch('/api/check_port_status')
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          const ports = data.ports || [];
          if (ports.length === 0) {
            openPortsContent.innerHTML = 'No configured ports found.';
          } else {
            // Display ports in a better format
            const portsList = ports.map(port => 
              `• Port ${port.port}: ${port.name || 'Unnamed'} - ${port.enabled ? '✅ Enabled' : '❌ Disabled'}`
            ).join('\n');
            openPortsContent.innerHTML = `System Ports Status:\n\n${portsList}`;
          }
        } else {
          openPortsContent.innerHTML = 'Error loading system ports: ' + (data.message || 'Unknown error');
        }
      })
      .catch(err => {
        openPortsContent.innerHTML = 'Error loading system ports: ' + err.message;
      });
  }

  // Add new port
  function addNewPort(event) {
    event.preventDefault();
    
    const portName = document.getElementById('new-port-name').value;
    const portNumber = document.getElementById('new-port-number').value;
    const portEnabled = document.getElementById('new-port-enabled').checked;

    if (!portName || !portNumber) {
      showNotification('Please fill in all fields', 'error');
      return;
    }

    const newPort = {
      name: portName,
      port: parseInt(portNumber),
      enabled: portEnabled
    };

    // Add to local data
    portsData.push(newPort);
    hasUnsavedChanges = true;
    
    // Clear form
    addPortForm.reset();
    document.getElementById('new-port-enabled').checked = true;
    
    // Re-render table
    renderPortsTable();
    updateApplyButton();
    
    showNotification('Port added to configuration. Click "Apply Changes" to save.', 'success');
  }

  // Delete port
  function deletePort(portId) {
    const port = portsData.find(p => (p.id || p.port) == portId);
    if (port && port.isDefault) {
      showNotification('Cannot delete default system ports', 'error');
      return;
    }
    
    if (confirm('Are you sure you want to delete this port?')) {
      portsData = portsData.filter(port => (port.id || port.port) != portId);
      hasUnsavedChanges = true;
      renderPortsTable();
      updateApplyButton();
      showNotification('Port removed from configuration. Click "Apply Changes" to save.', 'success');
    }
  }

  // Update apply button state
  function updateApplyButton() {
    if (hasUnsavedChanges) {
      applyPortChangesBtn.style.background = '#28a745';
      applyPortChangesBtn.innerHTML = '<i class="fas fa-save"></i> Apply Changes (Unsaved)';
    } else {
      applyPortChangesBtn.style.background = '#007BFF';
      applyPortChangesBtn.innerHTML = '<i class="fas fa-save"></i> Apply Changes';
    }
  }

  // Apply port changes
  function applyPortChanges() {
    if (!hasUnsavedChanges) {
      showNotification('No changes to apply', 'error');
      return;
    }

    const btn = applyPortChangesBtn;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Applying...';
    btn.disabled = true;

    // Update ports data with current toggle states
    portsData.forEach(port => {
      const toggle = portsTable.querySelector(`.port-toggle[data-port-id="${port.id || port.port}"]`);
      if (toggle) {
        port.enabled = toggle.checked;
      }
    });

    // Separate default ports and custom ports
    const defaultPorts = portsData.filter(port => port.isDefault);
    const customPorts = portsData.filter(port => !port.isDefault);
    const allPorts = [...defaultPorts, ...customPorts];

    fetch('/api/system_ports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        ports: allPorts,
        defaultPorts: defaultPorts,
        customPorts: customPorts
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        hasUnsavedChanges = false;
        updateApplyButton();
        showNotification(data.message || 'Port configuration applied successfully', 'success');
        if (portApplyStatus) {
          portApplyStatus.textContent = `Configuration applied at ${new Date().toLocaleTimeString()}`;
        }
      } else {
        showNotification(data.message || 'Failed to apply port configuration', 'error');
      }
    })
    .catch(err => {
      showNotification('Network error: ' + err.message, 'error');
    })
    .finally(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  }

  // Reset port changes
  function resetPortChanges() {
    if (hasUnsavedChanges && confirm('Are you sure you want to discard all unsaved changes?')) {
      loadPorts();
      hasUnsavedChanges = false;
      updateApplyButton();
      if (portApplyStatus) portApplyStatus.textContent = '';
      showNotification('Changes discarded', 'success');
    }
  }

  // Event listeners
  showOpenPortsBtn.addEventListener('click', showSystemOpenPorts);
  refreshPortsBtn.addEventListener('click', loadPorts);
  addPortForm.addEventListener('submit', addNewPort);
  applyPortChangesBtn.addEventListener('click', applyPortChanges);
  resetPortChangesBtn.addEventListener('click', resetPortChanges);

  // Load ports on page load
  loadPorts();

});
</script>
{% endblock %}
