{% extends "base.html" %}

{% block title %}Dashboard - Server Management{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <p>Welcome back, {{ user }}! Here's your server overview.</p>
    </div>

    <div class="dashboard-grid">
        <!-- System Status Card -->
        <div class="dashboard-card status-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h3>System Status</h3>
            </div>
            <div class="card-content">
                <div class="status-indicator">
                    <div class="status-dot online"></div>
                    <span>Online</span>
                </div>
                <div class="status-details">
                    <div class="status-item">
                        <span class="label">Uptime:</span>
                        <span class="value" id="uptime">{{ "%.0f"|format(system_info.uptime / 3600) }}h</span>
                    </div>
                    <div class="status-item">
                        <span class="label">OS:</span>
                        <span class="value">{{ system_info.os_info }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CPU Usage Card -->
        <div class="dashboard-card cpu-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-microchip"></i>
                </div>
                <h3>CPU Usage</h3>
            </div>
            <div class="card-content">
                <div class="metric-value">{{ system_info.cpu_percent }}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ system_info.cpu_percent }}%"></div>
                </div>
                <div class="metric-label">Current Load</div>
            </div>
        </div>

        <!-- Memory Usage Card -->
        <div class="dashboard-card memory-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-memory"></i>
                </div>
                <h3>Memory Usage</h3>
            </div>
            <div class="card-content">
                <div class="metric-value">{{ system_info.memory_percent }}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ system_info.memory_percent }}%"></div>
                </div>
                <div class="metric-label">{{ system_info.memory_used }}GB / {{ system_info.memory_total }}GB</div>
            </div>
        </div>

        <!-- Network Card -->
        <div class="dashboard-card network-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-network-wired"></i>
                </div>
                <h3>Network</h3>
            </div>
            <div class="card-content">
                <div class="network-info">
                    <div class="network-item">
                        <span class="label">IP Address:</span>
                        <span class="value">{{ system_info.ip }}</span>
                    </div>
                    <div class="network-item">
                        <span class="label">MAC Address:</span>
                        <span class="value">{{ system_info.mac_address }}</span>
                    </div>
                    <div class="network-item">
                        <span class="label">Serial Number:</span>
                        <span class="value">{{ system_info.serial_number }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="dashboard-card actions-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h3>Quick Actions</h3>
            </div>
            <div class="card-content">
                <div class="quick-actions">
                    <a href="{{ url_for('system_page') }}" class="action-btn">
                        <i class="fas fa-microchip"></i>
                        <span>System Info</span>
                    </a>
                    <a href="{{ url_for('network_page') }}" class="action-btn">
                        <i class="fas fa-network-wired"></i>
                        <span>Network Config</span>
                    </a>
                    <a href="{{ url_for('remote_check_page') }}" class="action-btn">
                        <i class="fas fa-search"></i>
                        <span>Remote Check</span>
                    </a>
                    {% if role == 'admin' %}
                    <a href="{{ url_for('users_page') }}" class="action-btn">
                        <i class="fas fa-users"></i>
                        <span>Manage Users</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>




    <!-- Real-time Chart -->
    <div class="dashboard-chart">
        <div class="chart-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3>System Performance</h3>
                <div class="chart-controls">
                </div>
            </div>
            <div class="card-content">
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize performance chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU %',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            }, {
                label: 'Memory %',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });

    // Real-time data update
    function updateSystemData() {
        fetch('/api/system_info')
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                // Update dashboard metrics
                document.querySelector('.cpu-card .metric-value').textContent = data.cpu_percent + '%';
                document.querySelector('.cpu-card .progress-fill').style.width = data.cpu_percent + '%';
                
                document.querySelector('.memory-card .metric-value').textContent = data.memory_percent + '%';
                document.querySelector('.memory-card .progress-fill').style.width = data.memory_percent + '%';
                document.querySelector('.memory-card .metric-label').textContent = 
                    data.memory_used + 'GB / ' + data.memory_total + 'GB';
                
                // Update chart
                const now = new Date().toLocaleTimeString();
                chart.data.labels.push(now);
                chart.data.datasets[0].data.push(data.cpu_percent);
                chart.data.datasets[1].data.push(data.memory_percent);
                
                // Keep only last 20 data points
                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                }
                
                chart.update('none');
            })
            .catch(error => console.error('Error fetching system data:', error));
    }

    // Update data every 5 seconds
    setInterval(updateSystemData, 5000);
    
    // Initial data load
    updateSystemData();

    // Chart period controls
    document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            // Here you could implement different data periods
        });
    });

    // Animate cards on load
    const cards = document.querySelectorAll('.dashboard-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-in');
    });
});
</script>
{% endblock %}