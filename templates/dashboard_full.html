<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full System & Docker Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { margin:0; font-family:'Segoe UI',sans-serif; background:linear-gradient(135deg,#1f1f2e,#32334d); color:#fff; }
.container { padding:2rem; max-width: 1400px; }
h1{text-align:center; margin-bottom:2rem; color:#fff;}
.card { background:#fff; color:#000; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.3); padding:1rem; margin-bottom:1.5rem; }
.card h2{ font-size:16px; font-weight:bold; }
.card small{ color:#666; }
.row>[class*="col"]{display:flex; flex-direction:column;}
.chart-container{height:60px;}
.ip-box{background:#1f1f2e; color:#fff; padding:10px; border-radius:10px; margin-top:5px; text-align:center;}
.section-title{color:#fff; font-size:1.5rem; font-weight:bold; margin:15px 0;}
.btn-group button{margin-right:5px;}
#logs{height:300px; overflow-y:auto;}
.nginx-status-indicator{width:15px; height:15px; border-radius:50%; display:inline-block; margin-right:5px; }
</style>
</head>
<body>
<div class="container">
<h1>System & Docker Dashboard</h1>

<!-- System Cards -->
<div class="section-title">System Metrics</div>
<div class="row">
<div class="col-md-3"><div class="card"><h5>Private IP</h5><div class="ip-box" id="private-ip">--</div></div></div>
<div class="col-md-3"><div class="card"><h5>Public IP</h5><div class="ip-box" id="public-ip">--</div></div></div>
<div class="col-md-3"><div class="card"><h5>Hostname</h5><div class="ip-box" id="hostname">--</div></div></div>
<div class="col-md-3"><div class="card"><h5>OS Type</h5><div class="ip-box" id="os_type">--</div></div></div>
</div>

<div class="row">
<div class="col-md-3"><div class="card"><h2 id="cpu">0%</h2><small><b>CPU Usage</b> | <span id="cpu-time">--</span></small><div class="chart-container"><canvas id="cpuChart"></canvas></div></div></div>
<div class="col-md-3"><div class="card"><h2 id="mem">0 / 0 GB</h2><small><b>Memory Usage </b>| <span id="mem-time">--</span></small><div class="chart-container"><canvas id="memChart"></canvas></div></div></div>
<div class="col-md-3"><div class="card"><h2 id="disk">0 / 0 GB</h2><small><b>Disk Usage</b> | <span id="disk-time">--</span></small><div class="chart-container"><canvas id="diskChart"></canvas></div></div></div>
<div class="col-md-3"><div class="card"><h2 id="net">0 / 0 Mbps</h2><small><b>Network</b> | <span id="net-time">--</span></small><div class="chart-container"><canvas id="netChart"></canvas></div></div></div>
</div>

<!-- Docker Services -->
<div class="section-title">Docker Services</div>
<div class="row">
<div class="col-md-12">
  <div id="services-list" class="mb-3"></div>
  <div id="service-details" style="display:none;">
    <button class="btn btn-secondary btn-sm mb-2" onclick="backToServices()">‚Üê Back</button>
    <div id="service-form"></div>
    <button class="btn btn-primary mt-2" onclick="saveAndRestart()">Save & Restart</button>
    <pre id="logs"></pre>
  </div>
</div>
</div>

<!-- Nginx Control -->
<div class="section-title">Nginx Control</div>
<div class="row">
<div class="col-md-12">
  <div class="card p-3 d-flex flex-row align-items-center justify-content-between">
    <div>
      <span class="nginx-status-indicator" id="nginx-status"></span>
      <span id="nginx-status-text">Checking...</span>
    </div>
    <div class="btn-group">
      <button class="btn btn-success btn-sm" onclick="nginxAction('start')">Start</button>
      <button class="btn btn-danger btn-sm" onclick="nginxAction('stop')">Stop</button>
      <button class="btn btn-warning btn-sm" onclick="nginxAction('restart')">Restart</button>
      <button class="btn btn-info btn-sm" onclick="nginxAction('status')">Status</button>
    </div>
  </div>
</div>
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ----------------------------
// Charts & Metrics
// ----------------------------
let cpuData=[], memData=[], diskData=[], netData=[], maxPoints=20;

const cpuChart=new Chart(document.getElementById("cpuChart"),{type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#ff6384',fill:false,tension:0.3}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});
const memChart=new Chart(document.getElementById("memChart"),{type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#36a2eb',fill:false,tension:0.3}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});
const diskChart=new Chart(document.getElementById("diskChart"),{type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#ffcd56',fill:false,tension:0.3}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});
const netChart=new Chart(document.getElementById("netChart"),{type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#4bc0c0',fill:false,tension:0.3}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});

async function updateMetrics(){
  const res=await fetch("/api/metrics"); const d=await res.json();
  cpuData.push(d.cpu_percent); if(cpuData.length>maxPoints) cpuData.shift();
  cpuChart.data.labels=cpuData.map((_,i)=>i); cpuChart.data.datasets[0].data=cpuData; cpuChart.update();
  document.getElementById("cpu").innerText=d.cpu_percent+"%"; document.getElementById("cpu-time").innerText=d.timestamp;

  memData.push(d.mem_used); if(memData.length>maxPoints) memData.shift();
  memChart.data.labels=memData.map((_,i)=>i); memChart.data.datasets[0].data=memData; memChart.update();
  document.getElementById("mem").innerText=d.mem_used+" / "+d.mem_total+" GB"; document.getElementById("mem-time").innerText=d.timestamp;

  diskData.push(d.disk_used); if(diskData.length>maxPoints) diskData.shift();
  diskChart.data.labels=diskData.map((_,i)=>i); diskChart.data.datasets[0].data=diskData; diskChart.update();
  document.getElementById("disk").innerText=d.disk_used+" / "+d.disk_total+" GB"; document.getElementById("disk-time").innerText=d.timestamp;

  netData.push(d.upload_speed+d.download_speed); if(netData.length>maxPoints) netData.shift();
  netChart.data.labels=netData.map((_,i)=>i); netChart.data.datasets[0].data=netData; netChart.update();
  document.getElementById("net").innerText=d.upload_speed+" / "+d.download_speed+" Mbps"; document.getElementById("net-time").innerText=d.timestamp;

  document.getElementById("private-ip").innerText=d.private_ip;
  document.getElementById("public-ip").innerText=d.public_ip;
  document.getElementById("hostname").innerText=d.hostname;
  document.getElementById("os_type").innerText=d.os_type;
}

// ----------------------------
// Docker Services
// ----------------------------
async function loadServices(){
  const r=await fetch("/api/services"); const d=await r.json();
  document.getElementById("services-list").innerHTML=d.map(s=>`<button class='btn btn-outline-primary m-1' onclick="openService('${s}')">${s}</button>`).join('');
}
let currentService=null, serviceData=null;
async function openService(name){
  currentService=name;
  const r=await fetch(`/api/service/${name}`); serviceData=await r.json();
  let formHtml="";
  for(let [sname,svc] of Object.entries(serviceData.services)){
    formHtml+=`<h5>${sname}</h5><table class="table table-sm"><tr><th>Env</th><th>Value</th></tr>`;
    svc.environment_list.forEach((e,i)=>{formHtml+=`<tr><td>${e.name}</td><td><input class='form-control form-control-sm' value='${e.value}' onchange="serviceData.services['${sname}'].environment_list[${i}].value=this.value"></td></tr>`;});
    formHtml+=`<tr><td>Port Range</td><td><input class='form-control form-control-sm' value='${svc.port_range || ""}' placeholder='e.g., 8000-8100' onchange="serviceData.services['${sname}'].port_range=this.value"></td></tr>`;
    formHtml+="</table>";
  }
  document.getElementById("service-form").innerHTML=formHtml;
  document.getElementById("services-list").style.display="none";
  document.getElementById("service-details").style.display="block";
}
function backToServices(){document.getElementById("services-list").style.display="block";document.getElementById("service-details").style.display="none";document.getElementById("logs").innerText="";}
async function saveAndRestart(){
  document.getElementById("logs").innerText="Restarting...";
  const r=await fetch(`/api/service/${currentService}/restart`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(serviceData)});
  const reader=r.body.getReader(); const decoder=new TextDecoder(); let log="";
  while(true){const {done,value}=await reader.read(); if(done)break; log+=decoder.decode(value); document.getElementById("logs").innerHTML=log;}
}

// ----------------------------
// Nginx Control
// ----------------------------
async function nginxAction(action){
  const r=await fetch(`/api/nginx/${action}`,{method:'POST'}); const d=await r.json();
  if(action==="status"){ updateNginxStatus(d.running); }
  else{ nginxAction('status'); }
}
function updateNginxStatus(running){
  let el=document.getElementById("nginx-status"); let txt=document.getElementById("nginx-status-text");
  if(running){ el.style.background="green"; txt.innerText="Running"; } else{ el.style.background="red"; txt.innerText="Stopped"; }
}

// ----------------------------
// Init
// ----------------------------
setInterval(updateMetrics,2000); updateMetrics(); loadServices(); nginxAction('status');
</script>
</body>
</html>

